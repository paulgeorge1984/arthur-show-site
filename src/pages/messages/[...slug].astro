---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('daily-messages');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---

<Layout title={entry.data.title} description={entry.data.description}>
	
	<div id="video-anchor" class="video-anchor">
		<div id="floating-player" class="player-container">
			<div class="video-inner">
				<iframe 
					src={`https://www.youtube.com/embed/${entry.data.youtubeId}?rel=0`} 
					title="YouTube video player" 
					frameborder="0" 
					allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
					allowfullscreen>
				</iframe>
			</div>
			<button id="close-pip" class="pip-close-btn" aria-label="Close PiP">×</button>
		</div>
	</div>

	<article class="content-area">
		<Content />
	</article>

</Layout>

<script>
	const anchor = document.getElementById('video-anchor');
	const player = document.getElementById('floating-player');
	const closeBtn = document.getElementById('close-pip');

	if (anchor && player && closeBtn) {
		const observer = new IntersectionObserver((entries) => {
			if (window.innerWidth <= 768) return; // スマホは除外

			entries.forEach(entry => {
				// 上にスクロールアウトしたらPiPオン
				if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
					player.classList.add('is-pip');
				} else {
					// 見えてる時は通常モード
					player.classList.remove('is-pip');
					player.classList.remove('pip-hidden');
				}
			});
		}, {
			rootMargin: '-100px 0px 0px 0px',
			threshold: 0
		});

		observer.observe(anchor);

		closeBtn.addEventListener('click', () => {
			player.classList.add('pip-hidden');
		});
	}
</script>

<style>
	/* --- 共通設定 --- */
	.video-anchor {
		width: 100%;
		aspect-ratio: 16 / 9;
		max-width: 1000px;
		margin: 0 auto;
		position: relative;
		background: #000;
	}

	.player-container {
		width: 100%;
		height: 100%;
		background: #000;
		transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
	}

	.video-inner {
		width: 100%;
		height: 100%;
		position: relative;
	}

	iframe {
		width: 100%;
		height: 100%;
		display: block;
	}

	.content-area {
		max-width: 800px;
		margin: 0 auto;
		padding: 40px 20px;
		background: #fff;
		position: relative;
		z-index: 10;
	}

	/* --- PC用 PiPスタイル (右上配置) --- */
	@media (min-width: 769px) {
		.player-container.is-pip {
			position: fixed;
			/* ★ここを変更：右上（ヘッダーの下）に配置 */
			top: 100px; 
			right: 20px;
			
			width: 360px; /* 少しサイズアップして見やすく */
			height: 202px; /* 16:9比率 */
			
			z-index: 999;
			box-shadow: 0 10px 40px rgba(0,0,0,0.3);
			border: 2px solid #c5a059;
			border-radius: 8px;
			overflow: hidden;
		}

		.player-container.is-pip.pip-hidden {
			transform: translateX(120%); /* 右に隠れるアニメーション */
			opacity: 0;
			pointer-events: none;
		}

		.pip-close-btn {
			position: absolute;
			top: -10px;
			left: -10px; /* 右上配置なので、ボタンは左上に変更すると誤クリックしにくい */
			width: 24px;
			height: 24px;
			background: #c5a059;
			color: #000;
			border: none;
			border-radius: 50%;
			font-weight: bold;
			cursor: pointer;
			display: none;
			align-items: center;
			justify-content: center;
			font-size: 16px;
			line-height: 1;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
			z-index: 1000;
		}

		.player-container.is-pip .pip-close-btn {
			display: flex;
		}
		
		.player-container.is-pip:hover .pip-close-btn {
			transform: scale(1.1);
		}
	}

	/* --- スマホ用 (スティッキー維持) --- */
	@media (max-width: 768px) {
		.video-anchor {
			aspect-ratio: auto;
			height: auto;
			position: -webkit-sticky;
			position: sticky;
			top: 84px;
			z-index: 90;
		}

		.player-container {
			width: 100%;
			aspect-ratio: 16 / 9;
			box-shadow: 0 5px 15px rgba(0,0,0,0.5);
		}

		.pip-close-btn {
			display: none;
		}
		
		.content-area {
			padding: 20px 15px;
		}
	}
</style>